<script>
    console.log('✓ QA Form Script Loading...');

    // =========================
    // BASIC FORM CONFIGURATION
    // =========================

    // Page Navigation
    let currentPage = 1;
    const totalPages = 2;
    const pages = document.querySelectorAll('.page');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    const progressFill = document.getElementById('progressFill');
    const currentPageSpan = document.getElementById('currentPage');

    function showPage(pageNum) {
        pages.forEach((page, index) => {
            page.classList.remove('active');
            if (index === pageNum - 1) {
                page.classList.add('active');
            }
        });

        currentPage = pageNum;
        currentPageSpan.textContent = pageNum;

        // Update progress bar
        const progress = (pageNum / totalPages) * 100;
        progressFill.style.width = progress + '%';

        // Show/hide navigation buttons
        prevBtn.style.display = pageNum === 1 ? 'none' : 'block';
        nextBtn.style.display = pageNum === totalPages ? 'none' : 'block';
        submitBtn.style.display = pageNum === totalPages ? 'block' : 'none';
    }

    nextBtn.addEventListener('click', () => {
        if (validatePage(currentPage)) {
            showPage(currentPage + 1);
            window.scrollTo(0, 0);
        }
    });

    prevBtn.addEventListener('click', () => {
        showPage(currentPage - 1);
        window.scrollTo(0, 0);
    });

    // =========================
    // CONDITIONAL LOGIC: REGION
    // =========================

    const regionSelect = document.getElementById('regionSelect');
    const houstonLocations = document.getElementById('houstonLocations');

    if (!regionSelect) {
        console.error('ERROR: regionSelect element not found!');
    }
    if (!houstonLocations) {
        console.error('ERROR: houstonLocations element not found!');
    }

    if (regionSelect && houstonLocations) {
        console.log('✓ Region dropdown and Houston locations div found successfully');

        regionSelect.addEventListener('change', function () {
            console.log('=== Region Changed ===');
            console.log('Selected value:', this.value);

            const select = houstonLocations.querySelector('select');

            // Reset - hide Houston location field
            houstonLocations.classList.add('hidden');
            houstonLocations.style.cssText = 'display: none;';
            if (select) {
                select.removeAttribute('required');
                select.value = '';
            }

            // Show Houston plants when Houston is selected
            if (this.value === 'Houston') {
                console.log('✓ HOUSTON SELECTED - Showing plant dropdown');
                houstonLocations.classList.remove('hidden');
                houstonLocations.style.cssText = 'display: block;';
                if (select) {
                    select.setAttribute('required', 'required');
                }
            }
        });
    }

    // =========================
    // FILE UPLOAD / IMAGES
    // =========================

    const photoUpload = document.getElementById('photoUpload');
    const fileList = document.getElementById('fileList');
    const uploadedFiles = [];

    if (photoUpload && fileList) {
        photoUpload.addEventListener('change', async function () {
            const files = Array.from(this.files || []);

            for (let file of files) {
                if (!file.type.startsWith('image/')) {
                    showError('Please upload only image files');
                    continue;
                }

                if (file.size > 10 * 1024 * 1024) {
                    showError(`File ${file.name} is too large. Maximum size is 10MB.`);
                    continue;
                }

                try {
                    const compressedImage = await compressImage(file);
                    uploadedFiles.push({
                        name: file.name,
                        data: compressedImage
                    });
                } catch (error) {
                    console.error('Error processing image:', error);
                    showError(`Failed to process ${file.name}`);
                }
            }

            displayFiles();
            photoUpload.value = '';
        });
    }

    function compressImage(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    let width = img.width;
                    let height = img.height;
                    const MAX = 1920;

                    if (width > MAX || height > MAX) {
                        if (width > height) {
                            height = (height / width) * MAX;
                            width = MAX;
                        } else {
                            width = (width / height) * MAX;
                            height = MAX;
                        }
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                };
                img.onerror = reject;
                img.src = e.target.result;
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    function displayFiles() {
        fileList.innerHTML = '';
        uploadedFiles.forEach((file, index) => {
            const preview = document.createElement('div');
            preview.className = 'image-preview';
            preview.innerHTML = `
                <img src="${file.data}" alt="${file.name}">
                <button type="button" class="remove-btn" onclick="removeFile(${index})">×</button>
            `;
            fileList.appendChild(preview);
        });
    }

    function removeFile(index) {
        uploadedFiles.splice(index, 1);
        displayFiles();
    }

    // =========================
    // VALIDATION
    // =========================

    function validatePage(pageNum) {
        const currentPageDiv = document.getElementById(`page${pageNum}`);
        const requiredFields = currentPageDiv.querySelectorAll('[required]');
        let isValid = true;
        let firstInvalidField = null;

        requiredFields.forEach(field => {
            // Skip hidden required fields
            const formGroup = field.closest('.form-group');
            if (formGroup && formGroup.classList.contains('hidden')) {
                return;
            }

            if (field.type === 'radio') {
                const radioGroup = currentPageDiv.querySelectorAll(`[name="${field.name}"]`);
                const isChecked = Array.from(radioGroup).some(radio => radio.checked);
                if (!isChecked) {
                    isValid = false;
                    if (!firstInvalidField) {
                        firstInvalidField = field;
                    }
                }
            } else if (!field.value || field.value.trim() === '') {
                isValid = false;
                field.style.borderColor = 'var(--danger-color)';
                if (!firstInvalidField) {
                    firstInvalidField = field;
                }
            } else {
                field.style.borderColor = '';
            }
        });

        if (!isValid) {
            showError('Please fill in all required fields');
            if (firstInvalidField) {
                firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        return isValid;
    }

    // =========================
    // FORM SUBMISSION (EMAIL)
    // =========================

    document.getElementById('qaForm').addEventListener('submit', function (e) {
        e.preventDefault();

        if (!validatePage(currentPage)) {
            return;
        }

        const loadingSpinner = document.getElementById('loadingSpinner');
        loadingSpinner.classList.add('show');

        const formData = new FormData(this);
        const data = {};
        formData.forEach((value, key) => {
            data[key] = value;
        });

        // Get target email from "Your Email" field
        const targetEmail = data.email;

        if (!targetEmail) {
            loadingSpinner.classList.remove('show');
            showError('Please enter a valid email address in the "Your Email" field.');
            return;
        }

        // Build email body from form fields
        const bodyLines = [];
        bodyLines.push('QA Plant Visit Checklist');
        bodyLines.push('----------------------------------------');
        bodyLines.push('');

        Object.keys(data).forEach(key => {
            if (key === 'email') return;        // we use this as "to"
            if (key === 'photos') return;       // files cannot be attached via mailto
            const label = key.replace(/_/g, ' ');
            bodyLines.push(label + ': ' + data[key]);
        });

        if (uploadedFiles.length > 0) {
            bodyLines.push('');
            bodyLines.push('Photos: ' + uploadedFiles.length + ' image file(s) were selected in this report.');
            bodyLines.push('(Note: Attach photos manually in your email client if they are not auto-attached.)');
        }

        bodyLines.push('');
        bodyLines.push('Submitted at: ' + new Date().toLocaleString());

        const subject = 'QA Plant Visit Checklist';
        const mailtoLink =
            'mailto:' + encodeURIComponent(targetEmail) +
            '?subject=' + encodeURIComponent(subject) +
            '&body=' + encodeURIComponent(bodyLines.join('\r\n'));

        // Hide spinner before launching mail client
        loadingSpinner.classList.remove('show');

        // Open user's mail app with prefilled email
        window.location.href = mailtoLink;

        // Show on-page success message and hide form
        this.style.display = 'none';
        document.getElementById('successMessage').classList.add('show');
    });

    // =========================
    // ERROR HELPER + DEFAULTS
    // =========================

    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        document.getElementById('errorText').textContent = message;
        errorDiv.classList.add('show');
        setTimeout(() => {
            errorDiv.classList.remove('show');
        }, 5000);
    }

    // Set today's date by default on load and initial page state
    document.addEventListener('DOMContentLoaded', function () {
        const dateInput = document.querySelector('input[name="visit_date"]');
        if (dateInput) {
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
        }
        showPage(1);
    });

    // Expose removeFile globally for inline onclick
    window.removeFile = removeFile;
</script>
